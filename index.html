<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Sitemap Structured Data Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1em;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .inline-input {
            display: flex;
            gap: 10px;
        }
        
        .inline-input input {
            flex: 1;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1a73e8;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1557b0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .batch-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .batch-buttons span {
            font-weight: 600;
            color: #333;
        }
        
        .batch-btn {
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .batch-btn.batch-1 { background: #28a745; color: white; }
        .batch-btn.batch-2 { background: #17a2b8; color: white; }
        .batch-btn.batch-3 { background: #ffc107; color: #333; }
        .batch-btn.batch-4 { background: #fd7e14; color: white; }
        .batch-btn.batch-5 { background: #dc3545; color: white; }
        .batch-btn.batch-6 { background: #6f42c1; color: white; }
        .batch-btn.batch-7 { background: #20c997; color: white; }
        .batch-btn.batch-8 { background: #e83e8c; color: white; }
        .batch-btn.batch-9 { background: #6c757d; color: white; }
        .batch-btn.batch-10 { background: #343a40; color: white; }
        
        .url-count {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .url-list {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .url-item {
            border-bottom: 1px solid #e0e0e0;
            background: white;
        }
        
        .url-item:last-child {
            border-bottom: none;
        }
        
        .url-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .url-header:hover {
            background: #f8f9fa;
        }
        
        .url-number {
            min-width: 40px;
            font-weight: 600;
            color: #666;
        }
        
        .url-text {
            flex: 1;
            color: #1a0dab;
            word-break: break-all;
            font-size: 14px;
        }
        
        .url-batch {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .url-status {
            display: flex;
            gap: 8px;
            margin-left: 15px;
        }
        
        .status-btn {
            padding: 4px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: 2px solid transparent;
        }
        
        .status-btn.pass {
            background: #e6f4ea;
            color: #188038;
            border-color: #188038;
        }
        
        .status-btn.pass.active {
            background: #188038;
            color: white;
        }
        
        .status-btn.fail {
            background: #fce8e6;
            color: #c5221f;
            border-color: #c5221f;
        }
        
        .status-btn.fail.active {
            background: #c5221f;
            color: white;
        }
        
        .url-arrow {
            color: #999;
            margin-left: 10px;
            transition: transform 0.2s;
        }
        
        .url-arrow.expanded {
            transform: rotate(180deg);
        }
        
        .url-details {
            display: none;
            padding: 16px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }
        
        .url-details.expanded {
            display: block;
        }
        
        .url-details a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #1a73e8;
            text-decoration: none;
            font-weight: 500;
            padding: 10px 16px;
            background: #e8f0fe;
            border-radius: 6px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .url-details a:hover {
            background: #d2e3fc;
        }
        
        .url-details a svg {
            width: 18px;
            height: 18px;
        }
        
        .notes-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: white;
        }
        
        .summary-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .summary-card.passed { background: #28a745; }
        .summary-card.failed { background: #dc3545; }
        .summary-card.pending { background: #6c757d; }
        
        .summary-card h3 {
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .summary-card .number {
            font-size: 32px;
            font-weight: bold;
        }
        
        .github-section {
            background: #f0f7ff;
            border: 2px solid #1a73e8;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .github-section h3 {
            color: #1a73e8;
            margin-bottom: 15px;
        }
        
        .report-link-box {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .report-link-box h3 {
            color: #155724;
            margin-bottom: 10px;
        }
        
        .report-link-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid #28a745;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-message.active {
            display: block;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .info-box {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç XML Sitemap Structured Data Tester</h1>
        <p class="subtitle">Fetch URLs from sitemap, test them in Google Rich Results Test, and generate a report</p>
        
        <div class="input-section">
            <div class="input-group">
                <label for="sitemapUrl">Sitemap URL</label>
                <div class="inline-input">
                    <input type="text" id="sitemapUrl" placeholder="https://example.com/sitemap.xml" value="https://www.dentistempire.com/page-sitemap.xml">
                    <button class="btn-primary" id="fetchBtn" onclick="fetchSitemap()">
                        <span id="fetchBtnText">Fetch URLs</span>
                    </button>
                </div>
            </div>
            
            <div class="info-box">
                <strong>How to use:</strong><br>
                1. Enter sitemap URL and click "Fetch URLs"<br>
                2. Click batch buttons to open 10 URLs at a time in Google Rich Results Test<br>
                3. Mark each URL as Pass ‚úì or Fail ‚úó based on the test results<br>
                4. Export the report to HTML or upload to GitHub Pages
            </div>
        </div>
        
        <div id="errorMessage" class="error-message"></div>
        
        <div id="resultsSection" class="hidden">
            <div class="summary-cards">
                <div class="summary-card total">
                    <h3>Total URLs</h3>
                    <div class="number" id="totalCount">0</div>
                </div>
                <div class="summary-card passed">
                    <h3>Passed</h3>
                    <div class="number" id="passedCount">0</div>
                </div>
                <div class="summary-card failed">
                    <h3>Failed</h3>
                    <div class="number" id="failedCount">0</div>
                </div>
                <div class="summary-card pending">
                    <h3>Pending</h3>
                    <div class="number" id="pendingCount">0</div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn-success" onclick="expandAll()">Expand All</button>
                <button class="btn-danger" onclick="collapseAll()">Collapse All</button>
                <button class="btn-warning" onclick="markAllPassed()">Mark All Passed</button>
                <button class="btn-secondary" onclick="resetAll()">Reset All</button>
            </div>
            
            <div class="url-count" id="urlCount">Processed 0 URLs</div>
            
            <div class="batch-buttons" id="batchButtons">
                <span>Open in batches:</span>
            </div>
            
            <div class="url-list" id="urlList"></div>
            
            <div class="github-section">
                <h3>üì§ Export Report</h3>
                <div class="input-group">
                    <label for="githubToken">GitHub Personal Access Token (optional - for uploading)</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                </div>
                <div class="input-group">
                    <label for="githubRepo">GitHub Repository (optional - for uploading)</label>
                    <input type="text" id="githubRepo" placeholder="username/repo-name">
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="exportToHtml(false)">üì• Download HTML Report</button>
                    <button class="btn-success" onclick="exportToHtml(true)" id="uploadBtn">üì§ Upload to GitHub Pages</button>
                </div>
            </div>
            
            <div class="report-link-box" id="reportLinkBox">
                <h3>‚úÖ Report Uploaded Successfully!</h3>
                <p style="color: #155724; margin-bottom: 10px;">Your report has been uploaded to GitHub. Share this link:</p>
                <input type="text" id="reportLinkInput" readonly>
                <div class="button-group">
                    <button class="btn-success" onclick="copyReportLink()">üìã Copy Link</button>
                    <button class="btn-primary" onclick="openReportLink()">üîó Open Report</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allUrls = [];
        let urlStatuses = {}; // { url: { status: 'pass'|'fail'|'pending', notes: '' } }
        const BATCH_SIZE = 10;
        
        // Load saved credentials
        window.addEventListener('DOMContentLoaded', function() {
            const savedToken = localStorage.getItem('github_token');
            const savedRepo = localStorage.getItem('github_repo');
            if (savedToken) document.getElementById('githubToken').value = savedToken;
            if (savedRepo) document.getElementById('githubRepo').value = savedRepo;
        });
        
        // CORS proxies for fallback
        const corsProxies = [
            (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
        ];
        
        async function fetchWithProxy(url) {
            for (const proxyFn of corsProxies) {
                try {
                    const proxyUrl = proxyFn(url);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    
                    const response = await fetch(proxyUrl, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        return await response.text();
                    }
                } catch (e) {
                    continue;
                }
            }
            throw new Error('Failed to fetch sitemap. Please try again.');
        }
        
        async function fetchSitemap() {
            const sitemapUrl = document.getElementById('sitemapUrl').value.trim();
            if (!sitemapUrl) {
                showError('Please enter a sitemap URL');
                return;
            }
            
            const fetchBtn = document.getElementById('fetchBtn');
            const fetchBtnText = document.getElementById('fetchBtnText');
            
            fetchBtn.disabled = true;
            fetchBtnText.innerHTML = '<span class="loading"></span> Fetching...';
            hideError();
            
            try {
                const text = await fetchWithProxy(sitemapUrl);
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, 'text/xml');
                
                const parserError = xmlDoc.querySelector('parsererror');
                if (parserError) {
                    throw new Error('Invalid XML sitemap');
                }
                
                const urlElements = xmlDoc.querySelectorAll('url > loc');
                allUrls = Array.from(urlElements).map(el => el.textContent.trim());
                
                if (allUrls.length === 0) {
                    throw new Error('No URLs found in sitemap');
                }
                
                // Initialize statuses
                urlStatuses = {};
                allUrls.forEach(url => {
                    urlStatuses[url] = { status: 'pending', notes: '' };
                });
                
                renderResults();
                document.getElementById('resultsSection').classList.remove('hidden');
                
            } catch (error) {
                showError(error.message);
            } finally {
                fetchBtn.disabled = false;
                fetchBtnText.textContent = 'Fetch URLs';
            }
        }
        
        function renderResults() {
            renderSummary();
            renderBatchButtons();
            renderUrlList();
        }
        
        function renderSummary() {
            const total = allUrls.length;
            const passed = Object.values(urlStatuses).filter(s => s.status === 'pass').length;
            const failed = Object.values(urlStatuses).filter(s => s.status === 'fail').length;
            const pending = total - passed - failed;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('passedCount').textContent = passed;
            document.getElementById('failedCount').textContent = failed;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('urlCount').textContent = `Processed ${total} URLs`;
        }
        
        function renderBatchButtons() {
            const container = document.getElementById('batchButtons');
            const numBatches = Math.ceil(allUrls.length / BATCH_SIZE);
            
            let html = '<span>Open in batches:</span>';
            for (let i = 0; i < numBatches; i++) {
                const start = i * BATCH_SIZE + 1;
                const end = Math.min((i + 1) * BATCH_SIZE, allUrls.length);
                const colorClass = `batch-${(i % 10) + 1}`;
                html += `<button class="batch-btn ${colorClass}" onclick="openBatch(${i})">Batch ${i + 1} (${start}-${end})</button>`;
            }
            container.innerHTML = html;
        }
        
        function renderUrlList() {
            const container = document.getElementById('urlList');
            let html = '';
            
            allUrls.forEach((url, index) => {
                const batchNum = Math.floor(index / BATCH_SIZE) + 1;
                const status = urlStatuses[url];
                const passActive = status.status === 'pass' ? 'active' : '';
                const failActive = status.status === 'fail' ? 'active' : '';
                const colorClass = `batch-${((batchNum - 1) % 10) + 1}`;
                
                html += `
                    <div class="url-item" data-index="${index}">
                        <div class="url-header" onclick="toggleUrl(${index})">
                            <span class="url-number">${index + 1}.</span>
                            <span class="url-text">${escapeHtml(url)}</span>
                            <span class="url-batch ${colorClass}">(Batch ${batchNum})</span>
                            <div class="url-status" onclick="event.stopPropagation()">
                                <button class="status-btn pass ${passActive}" onclick="setStatus(${index}, 'pass')">‚úì Pass</button>
                                <button class="status-btn fail ${failActive}" onclick="setStatus(${index}, 'fail')">‚úó Fail</button>
                            </div>
                            <span class="url-arrow" id="arrow-${index}">‚ñº</span>
                        </div>
                        <div class="url-details" id="details-${index}">
                            <a href="${getGoogleTestUrl(url)}" target="_blank">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                                Open in Google Rich Results Test
                            </a>
                            <a href="${url}" target="_blank">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
                                Visit Page
                            </a>
                            <div style="margin-top: 10px;">
                                <label style="font-size: 13px; color: #666;">Notes:</label>
                                <input type="text" class="notes-input" placeholder="Add notes about issues found..." 
                                    value="${escapeHtml(status.notes)}" 
                                    onchange="setNotes(${index}, this.value)">
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function getGoogleTestUrl(url) {
            return `https://search.google.com/test/rich-results?url=${encodeURIComponent(url)}`;
        }
        
        function openBatch(batchIndex) {
            const start = batchIndex * BATCH_SIZE;
            const end = Math.min(start + BATCH_SIZE, allUrls.length);
            
            for (let i = start; i < end; i++) {
                window.open(getGoogleTestUrl(allUrls[i]), '_blank');
            }
        }
        
        function toggleUrl(index) {
            const details = document.getElementById(`details-${index}`);
            const arrow = document.getElementById(`arrow-${index}`);
            
            details.classList.toggle('expanded');
            arrow.classList.toggle('expanded');
        }
        
        function setStatus(index, status) {
            const url = allUrls[index];
            urlStatuses[url].status = status;
            renderResults();
        }
        
        function setNotes(index, notes) {
            const url = allUrls[index];
            urlStatuses[url].notes = notes;
        }
        
        function expandAll() {
            document.querySelectorAll('.url-details').forEach(el => el.classList.add('expanded'));
            document.querySelectorAll('.url-arrow').forEach(el => el.classList.add('expanded'));
        }
        
        function collapseAll() {
            document.querySelectorAll('.url-details').forEach(el => el.classList.remove('expanded'));
            document.querySelectorAll('.url-arrow').forEach(el => el.classList.remove('expanded'));
        }
        
        function markAllPassed() {
            allUrls.forEach(url => {
                if (urlStatuses[url].status === 'pending') {
                    urlStatuses[url].status = 'pass';
                }
            });
            renderResults();
        }
        
        function resetAll() {
            allUrls.forEach(url => {
                urlStatuses[url].status = 'pending';
                urlStatuses[url].notes = '';
            });
            renderResults();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.classList.add('active');
        }
        
        function hideError() {
            document.getElementById('errorMessage').classList.remove('active');
        }
        
        async function exportToHtml(uploadToGitHub) {
            const total = allUrls.length;
            const passed = Object.values(urlStatuses).filter(s => s.status === 'pass').length;
            const failed = Object.values(urlStatuses).filter(s => s.status === 'fail').length;
            const pending = total - passed - failed;
            
            const sitemapUrl = document.getElementById('sitemapUrl').value.trim();
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            
            let tableRows = allUrls.map((url, index) => {
                const status = urlStatuses[url];
                const statusClass = status.status === 'pass' ? 'status-pass' : status.status === 'fail' ? 'status-fail' : 'status-pending';
                const statusText = status.status === 'pass' ? '‚úì PASS' : status.status === 'fail' ? '‚úó FAIL' : '‚è≥ PENDING';
                const googleUrl = getGoogleTestUrl(url);
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="url-cell"><a href="${url}" target="_blank">${url}</a></td>
                        <td><a href="${googleUrl}" target="_blank">Test Link</a></td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>${escapeHtml(status.notes)}</td>
                    </tr>
                `;
            }).join('');
            
            const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Structured Data Test Report - ${new Date().toLocaleDateString()}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 30px; }
        h1 { color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .summary-card { padding: 20px; border-radius: 8px; text-align: center; color: white; }
        .summary-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .summary-card.passed { background: #28a745; }
        .summary-card.failed { background: #dc3545; }
        .summary-card.pending { background: #6c757d; }
        .summary-card h3 { font-size: 14px; margin-bottom: 8px; opacity: 0.9; }
        .summary-card .number { font-size: 32px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        thead { background: #333; color: white; }
        th { padding: 12px 8px; text-align: left; font-weight: 600; }
        td { padding: 12px 8px; border-bottom: 1px solid #e9ecef; }
        tbody tr:hover { background: #f8f9fa; }
        .url-cell { max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .url-cell a { color: #1a0dab; text-decoration: none; }
        .url-cell a:hover { text-decoration: underline; }
        td a { color: #1a73e8; text-decoration: none; }
        td a:hover { text-decoration: underline; }
        .status-pass { color: #28a745; font-weight: 600; }
        .status-fail { color: #dc3545; font-weight: 600; }
        .status-pending { color: #6c757d; font-weight: 600; }
        .report-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .report-info p { margin: 5px 0; color: #666; }
        @media print { body { background: white; padding: 0; } .container { box-shadow: none; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Structured Data Test Report</h1>
        <p class="subtitle">Google Rich Results Test Analysis</p>
        
        <div class="report-info">
            <p><strong>Sitemap:</strong> ${escapeHtml(sitemapUrl)}</p>
            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            <p><strong>Total URLs Analyzed:</strong> ${total}</p>
        </div>
        
        <div class="summary-cards">
            <div class="summary-card total">
                <h3>Total URLs</h3>
                <div class="number">${total}</div>
            </div>
            <div class="summary-card passed">
                <h3>Passed</h3>
                <div class="number">${passed}</div>
            </div>
            <div class="summary-card failed">
                <h3>Failed</h3>
                <div class="number">${failed}</div>
            </div>
            <div class="summary-card pending">
                <h3>Pending</h3>
                <div class="number">${pending}</div>
            </div>
        </div>
        
        <h2>Detailed Results</h2>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>URL</th>
                    <th>Google Test</th>
                    <th>Status</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                ${tableRows}
            </tbody>
        </table>
        
        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <h3>Legend</h3>
            <p style="margin-top: 10px;">
                <span class="status-pass">‚úì PASS</span> - Structured data is valid<br>
                <span class="status-fail">‚úó FAIL</span> - Structured data has errors<br>
                <span class="status-pending">‚è≥ PENDING</span> - Not yet tested
            </p>
        </div>
    </div>
</body>
</html>`;
            
            const filename = `structured-data-report-${timestamp}.html`;
            
            if (uploadToGitHub) {
                const token = document.getElementById('githubToken').value.trim();
                const repo = document.getElementById('githubRepo').value.trim();
                
                if (!token || !repo) {
                    alert('Please enter GitHub token and repository to upload.');
                    return;
                }
                
                // Save credentials
                localStorage.setItem('github_token', token);
                localStorage.setItem('github_repo', repo);
                
                try {
                    document.getElementById('uploadBtn').disabled = true;
                    document.getElementById('uploadBtn').innerHTML = '<span class="loading"></span> Uploading...';
                    
                    const path = `reports/${filename}`;
                    const content = btoa(unescape(encodeURIComponent(htmlContent)));
                    
                    // Parse repository - handle username/repo format
                    const repoParts = repo.split('/');
                    if (repoParts.length !== 2) {
                        throw new Error('Repository format should be: username/repo-name');
                    }
                    const [owner, repoName] = repoParts;
                    
                    const response = await fetch(`https://api.github.com/repos/${owner}/${repoName}/contents/${path}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: `Add structured data report - ${new Date().toLocaleString()}`,
                            content: content
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to upload');
                    }
                    
                    // Generate the htmlpreview.github.io URL (instantly accessible!)
                    const rawUrl = `https://raw.githubusercontent.com/${owner}/${repoName}/main/${path}`;
                    const htmlPreviewUrl = `https://htmlpreview.github.io/?${rawUrl}`;
                    
                    // Try to shorten the URL using shrtco.de API
                    document.getElementById('uploadBtn').innerHTML = '<span class="loading"></span> Shortening URL...';
                    
                    let finalUrl = htmlPreviewUrl;
                    try {
                        const shortResponse = await fetch(`https://api.shrtco.de/v2/shorten?url=${encodeURIComponent(htmlPreviewUrl)}`);
                        if (shortResponse.ok) {
                            const shortData = await shortResponse.json();
                            if (shortData.ok && shortData.result && shortData.result.full_short_link) {
                                finalUrl = shortData.result.full_short_link;
                            }
                        }
                    } catch (e) {
                        // If shortening fails, use full URL
                        console.log('URL shortening failed, using full URL:', e);
                    }
                    
                    document.getElementById('reportLinkInput').value = finalUrl;
                    document.getElementById('reportLinkBox').style.display = 'block';
                    
                    // Scroll to the link box
                    document.getElementById('reportLinkBox').scrollIntoView({ behavior: 'smooth' });
                    
                } catch (error) {
                    alert('Failed to upload: ' + error.message);
                } finally {
                    document.getElementById('uploadBtn').disabled = false;
                    document.getElementById('uploadBtn').textContent = 'üì§ Upload to GitHub Pages';
                }
                
                try {
                    document.getElementById('uploadBtn').disabled = true;
                    document.getElementById('uploadBtn').innerHTML = '<span class="loading"></span> Uploading...';
                    
                    const path = `reports/${filename}`;
                    const content = btoa(unescape(encodeURIComponent(htmlContent)));
                    
                    const response = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: `Add structured data report - ${new Date().toLocaleString()}`,
                            content: content
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to upload');
                    }
                    
                    const repoOwner = repo.split('/')[0];
                    const repoName = repo.split('/')[1];
                    const reportUrl = `https://${repoOwner}.github.io/${repoName}/reports/${filename}`;
                    
                    document.getElementById('reportLinkInput').value = reportUrl;
                    document.getElementById('reportLinkBox').style.display = 'block';
                    
                } catch (error) {
                    alert('Failed to upload: ' + error.message);
                } finally {
                    document.getElementById('uploadBtn').disabled = false;
                    document.getElementById('uploadBtn').textContent = 'üì§ Upload to GitHub Pages';
                }
            } else {
                // Download locally
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
            }
        }
        
        function copyReportLink() {
            const input = document.getElementById('reportLinkInput');
            input.select();
            document.execCommand('copy');
            alert('Link copied to clipboard!');
        }
        
        function openReportLink() {
            window.open(document.getElementById('reportLinkInput').value, '_blank');
        }
    </script>
</body>
</html>
